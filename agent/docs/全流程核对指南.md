# 全流程核对指南

本文档用于人工审阅当前版本的数据可视化链路，覆盖命令入口、核心服务、LLM 插槽体系、绘图脚本生成、判分逻辑以及辅助数据集。每个章节给出关键文件位置与核对要点，便于逐条确认。

## 1. 项目结构速览
- 终端入口：`agent/run_chain.py`
- 服务编排：`agent/app/services/single_chain_runner.py`
- 沙盒执行：`agent/app/services/sandbox_runner.py`
- 绘图模版：`agent/app/runtime/scaffold_elements_pro.py.j2`
- 默认插槽：`agent/app/services/default_slots_v2.py`
- 评分判官：`agent/app/services/judge.py`
- 数据样例：`agent/data/*.csv`
- 运行产物：`agent/runs/<时间戳>/`

检查提示：确保 `.env` 已配置 LLM/VLM 相关 Key，Python 环境可访问 `pandas` 与 `matplotlib`。

## 2. CLI 入口流程（`agent/run_chain.py`）
1. 载入 `.env` 并初始化 `rich` 控制台。
2. 构建命令行参数（Excel/CSV 路径、用户意图、图形类型、轮数上限等）。
3. 显示实时面板：运行进度、LLM 往返、事件日志；底层通过 `Live` 动态刷新。
4. 调用 `run_chain()` 并捕获异常；异常会在界面中高亮显示，便于排查。

核对要点：确认 `--rounds`、`--intent` 的解析逻辑，尤其是 `--%` PowerShell 传参方式是否正确；默认支持 CSV/Excel（通过 `pandas.read_csv`/`read_excel`）。

## 3. 单链执行核心（`agent/app/services/single_chain_runner.py`）
1. 加载环境变量 → 初始化 `SlotLLMClient`（调用 Zhizengzeng Chat Completions，固定 JSON 输出）。
2. 读取数据表，派生基本 `intent/spec`（使用 `derive_spec`、`validate_spec`）。
3. 逐层（L1-L4）向 LLM 发送提示：
   - 提示中包含数据画像、意图、当前 spec、上一轮反馈。
   - 应答解析后按 `ALLOWED_BY_LAYER` 过滤插槽，拒绝越权调用。
4. 将汇总的 slot 体交给 `assemble_with_slots` 拼装为完整绘图脚本。
5. 通过 `execute_script` 沙盒执行：传入数据帧、意图、上下文；生成 `figure_round_x.png`。
6. 调用 `judge()` 评分并写出 `iteration_x.json`，其中记录 spec/slots/诊断日志。
7. 若得分满足阈值（≥0.75）提前停止；否则构建反馈文案继续下一轮。

核对要点：
- 观察 `ctx` 里 `_v2_meta`、`feedback_text` 是否向后继层正确传递。
- 确认 `assemble_with_slots` 返回的代码被写入 `runs/<ts>/scaffold.py`（可在产物目录校验）。
- `OUTPUT_CONTRACT` 描述了禁止导入的库，确保 LLM 输出遵守。

## 4. 沙盒执行与脚本模板
### 4.1 `agent/app/services/sandbox_runner.py`
- 将 slot 代码注入 `scaffold_elements_pro.py.j2` 并保存临时脚本。
- 通过子进程执行，限制导入与执行目录。
- 收集 `stdout/stderr`、更新上下文 `ctx`，以 JSON 形式返回。

### 4.2 `agent/app/runtime/scaffold_elements_pro.py.j2`
- 预设 Matplotlib 依赖（numpy、pandas、matplotlib.transforms 等）；
- 定义 slot 调度顺序：`scales → marks → colorbar → axes/grid/legend → annot → theme`。
- 新增的 `slot_scales_y_left_breaks` 接纳我们默认实现，用于绘制断轴标记。

核对要点：检查模板是否留有 “Forbidden import” 之外的引用；确认 `fig.tight_layout()` 和 `fig.savefig` 仍在结尾执行。

## 5. 默认插槽逻辑（`agent/app/services/default_slots_v2.py`）
### 5.1 L1：`spec.compose`
- 自动识别数值/类别/时间列，推断主 `x/y/group`。
- 支持多 overlay：目标线、预测、基准、趋势、次轴等角色；`meta['overlay_roles']` 记录角色信息。
- 新增 `scales.y_left.breaks` 默认逻辑：
  1. 聚合所有左轴系列，计算 0.9（或 0.75）分位数。
  2. 当极值显著偏离分位区间时，压缩高值区段并设置自定义 `function` 变换。
  3. 在 spec 中写入 `breaks=[[gap_start,gap_end]]`，并添加上下断口标记。
- 断轴示例数据：`agent/data/broken_demo.csv`。

### 5.2 L2：`data.prepare / aggregate / encode`
- 按 overlay 需要保留列，识别比率字段，生成 `_v2_meta['ratio_flags']`。
- 聚合逻辑默认 `sum` 或 `mean`（针对比率），保证 L3 可直接绘图。

### 5.3 L3：`marks.* / scales.*`
- 支持柱、线、面积、散点等常见类型；多 overlay 时会分配颜色与 zorder。
- `scales.y_left.kind/range` 自适应比率与阈值。
- `scales.y_left.breaks`（新增）会在此阶段应用压缩变换与断口标记。

### 5.4 L4：`axes/legend/grid/annot/theme`
- 标题、标签、刻度密度与旋转处理。
- 右轴标签自动补全、图例合并去重，断轴时会添加文字提示。

核对要点：
- 检查 `_nunique` 与 `_unique_ordered`，确保唯一值统计不会返回列表导致异常。
- `meta['font_scaling']` 控制标题/刻度字号，注意默认值是否合理。

## 6. 评分判官（`agent/app/services/judge.py`）
1. 首选调用 VLM（Zhizengzeng `/chat/completions`），附带图像 Base64、spec、数据列与执行日志。
2. 若 VLM 响应异常或无诊断，回退到启发式评分：
   - `visual_form` 通过像素差分估计；
   - `data_fidelity` 检查 overlay 引用列是否存在；
   - 附带预设诊断（缺标题、断轴提示、空图等）。
3. 设有 `VLM_DEBUG` 开关，调试时输出原始响应与解析错误。

核对要点：确认 `response_format={'type':'json_object'}` 已启用；若需手动调试，可在 `.env` 打开 `VLM_DEBUG=1`。

## 7. 数据集与基线运行
| 数据文件 | 场景 | 推荐命令 |
| --- | --- | --- |
| `agent/data/sales_demo.csv` | 中英分组柱图 | `python --% run_chain.py data/sales_demo.csv "季度对比" bar --rounds 1` |
| `agent/data/channel_share_dual.csv` | 面积 + 右轴趋势 | `python --% run_chain.py data/channel_share_dual.csv "渠道占比+营收" area --rounds 1` |
| `agent/data/product_scatter.csv` | 分组散点 + 柱混合 | `python --% run_chain.py data/product_scatter.csv "价格 vs 销量" scatter --rounds 1` |
| `agent/data/actual_target_plan.csv` | 目标/计划/基准线 | `python --% run_chain.py data/actual_target_plan.csv "业绩 vs 目标" line --rounds 1` |
| `agent/data/clinical_biomarkers.csv` | 双轴 + 面积/比率 | `python --% run_chain.py data/clinical_biomarkers.csv "试验指标" line --rounds 1` |
| `agent/data/gene_expression.csv` | 基因表达趋势 | `python --% run_chain.py data/gene_expression.csv "基因表达" line --rounds 1` |
| `agent/data/segment_ops.csv` | 部门开支柱图 | `python --% run_chain.py data/segment_ops.csv "部门开支" bar --rounds 1` |
| `agent/data/broken_demo.csv` | 断轴示例 | `python --% run_chain.py data/broken_demo.csv "含极值折线" line --rounds 1` |

核对要点：运行成功后，`agent/runs/<时间戳>/iteration_1.json` 中应包含更新的 `spec`、`slots` 与评分，图像保存在同目录下。

## 8. 推送前检查清单
1. `git status` 确认仅跟踪需要的源文件与数据样例，`agent/runs/` 等临时产物保持未加入版本控制。
2. 断轴逻辑需至少跑通 `broken_demo.csv`，确认 `spec['scales']['y_left']['breaks']` 被写入。
3. 若需调试 VLM，确保 `.env` 中 `LLM_API_KEY`/`VLM_API_KEY`、`LLM_API_BASE` 等字段正确。
4. 新增数据文件在 README 或当前文档中列出用途，便于他人复现。

---

如需进一步核对，可结合 `iteration_1.json` 的 `stages` 字段查看每层 prompt/response，以及 `_v2_meta` 内的推断细节。
